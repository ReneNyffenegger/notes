$ Antimalware Scan Interface (AMSI)

AMSI integrates with the following → Windows components
  • → Windows/security/User-account-control[User Account Control (UAC)
  • → Windows/PowerShell
  • → development/languages/WSH[Windows script Host] (and by extension JavaScript and → development/languages/VBScript)
  • → development/languages/VBA[Visual Basic for Applications]

{ «Forbidden» words

  AMSI detects possibly malicious code by search for text it does not like, so there are some forbidden words. If one of these
  words are entered in the command line (→ Windows/dirs/Windows/System32/cmd_exe[`cmd.exe`], → Windows/PowerShell etc.), AMSI
  kicks in with the error/warning message
 *This script contains malicious content and has been blocked by your antivirus software*.

  One such forbidden word is *amsiutils*:
  gh|Windows-Pics|/security/AMSI/script-contains-malicious-content.png||

  Another verboten string is for example *AmsiScanBuffer*, becuase this is the function in → Windows/dirs/Windows/System32/amsi_dll[`amsi.dll`] that
  is actually scanning for forbidden words, and a malware auther might have the idea to use `GetProcAddress` with `"AmsiScanBuffer"` and then replace
  the first three bytes of this function with `0x31`, `0xff` and `0x90` so that AmsiScanBuffer does nothing anymore.

  Then there is also
    • → https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/CodeExecution/Invoke-ReflectivePEInjection.ps1[Invoke-ReflectivePEInjection]
    • → https://www.powershellgallery.com/packages/PowerSploit/3.0.0.0/Content/CodeExecution%5CInvoke-DllInjection.ps1[Invoke-DllInjection]
    • …

}

sa:

  → Windows/dirs/ProgramData/Microsoft/Windows-Defender/Platform/_version_/MsMpEng_exe[`MsMpEng.exe`] is the *Antimalware Service Executable*.

  → Windows/dirs/Windows/System32/amsi_dll[`amsi.dll`]

  → Windows/registry/tree/HKEY_LOCAL_MACHINE/Software/Microsoft/AMSI[`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\AMSI`]

  The `IAntimalwareProvider` interface.

  → Windows/security[Windows security]

links:
  → https://0x00-0x00.github.io/research/2018/10/28/How-to-bypass-AMSI-and-Execute-ANY-malicious-powershell-code.html[This blog] provides some code to
  bypass AMSI. However, with newer versions of Windows, it does not work anymore.
